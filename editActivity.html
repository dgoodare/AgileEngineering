<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <!-- required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!--import bootstrap css-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <link rel="stylesheet" href="css/master.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300&display=swap" rel="stylesheet"> 

  <!-- favicon-->
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">

  <!-- link to manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- webpage title -->
  <title>ùïæùñöùñòùñôùñÜùñéùñìùñÜùñáùñëùñä ùïØùñöùñìùñâùñäùñä</title>
  <!--<title>‚òº üòÇüòÇüòÇüòÇüòÇüòÇ ‚òº</title>-->
  
  
  <script type="text/javascript" src="https://ajax.microsoft.com/ajax/jQuery/jquery-1.4.2.min.js"></script>
        <script type="text/javascript">
            //jQuery script for sending data to a php script to be added to the database
            $(document).ready(function()
            {
                $('#update-button').click(function()
                    {
                        //retrieve values from form based on ID of input
                        var search = $('#search-input').val();
                        var title = $('#update-title').val();
                        var description = $('#update-description').val();
                        var streetAddress = $('#update-address').val();
                        var city = $('#update-city').val();
                        var postcode = $('#update-postcode').val();
                        var number = $('#update-number').val();
                        var email = $('#update-email').val();
                        var goals = [];
			var latitude = 200;
			var longitude = 200;
			url = "https://api.mapbox.com/geocoding/v5/mapbox.places/"
			for(i of streetAddress.split(" ")){
				url = url+i+"%20";
			}
			for(i of city.split(" ")){
				url = url+i+"%20";
			}
			url = url+postcode+"%20";
			url = url+"United%20Kingdom%20";
			key = ".json?&access_token=pk.eyJ1Ijoiam9obmhhcnJvdzE1IiwiYSI6ImNrMnhqY2NleTBjYzgzZ3RhZXVrZ2toYnIifQ.Bd6-bNYAwA9_T_AR9c2bDA&limit=1"
                    
                        //get boolean values from checkbox fields
                        $('#editForm input[type=checkbox]').each(function()
                        {
                            if(this.checked)
                            {
                                goals.push(1);
                            }
                            else
                            {
                                goals.push(0);
                            }
                        });
			$.getJSON(url+key, function(data, status){
				longitude = data.features[0].geometry.coordinates[1];
				latitude = data.features[0].geometry.coordinates[0];
				ajaxs();
			});

                        //check that all fields have data
			function ajaxs(){
                        if (title != "" && latitude != 200 && longitude != 200 && description != "" && number != "" && email != "" && goals.length != 0)
                        {
                            //create JSON to be sent using AJAX
                            $.ajax(
                                {
                                    url: "https://ac31007.azurewebsites.net/api/updatePage",
                                    type: "POST",
                                    data: {
                                        ID: search,
                                        Title: title,
                                        Description: description,
                                        StreetAddress: streetAddress,
                                        City: city, 
                                        Postcode: postcode,
                                        Number: number,
                                        Email: email,
                                        Goals: goals
                                    },

                                    cache: false,

                                    success: function(dataResult)
                                    {
                                        var dataResult = JSON.parse(dataResult);
                                        //check if the data was added successfully
                                        if (dataResult.statusCode == 200)
                                        {
                                            //send success message 
                                            $('#server-response').html('Activity updated successfully!');
                                        }
                                        else if (dataResult.statusCode == 201)
                                        {
                                            //send failure message
                                            $('#server-response').html('Activity could not be added');
                                        }
                                        else
                                        {
                                            //send unknown error message
                                            $('#server-response').html('An unknown error occurred');
                                        }
                                    },
                                    error: function() {
                                       alert('There was an error performing the AJAX call');
                                    }

                                }
                            );
                        }
			else if(longitude == 200 && latitude == 200){
				alert("Sorry but we can't find gps cordinates to that address");
			}
                        else
                        {
                            //prompt user to fill in all fields
                            alert('Please make sure you enter data into ALL fields');
                        }}
                    }
                );
            });
        </script>
        <style>
            body{
                font-family: 'Nunito', sans-serif;
            }

            .goalCheckboxes{
                display: block;
            }
        </style>
  
  
</head>

<body>
  <div class="pageheight">
    <!-- header containing the navigation bar -->
    <header>
      <!-- navigation bar containing a logo, title and a link to each page -->
      <nav class="navbar fixed-top navbar-expand-sm navbar-dark bg-dark">
        <span class="navbar-brand">
          <img src="assets/susDundee1.png" alt="" width="40" height="40">
        </span>
        <span class="navbar-brand">Sustainable Dundee</span>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="goals.html">Goals</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="events.html">Events</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="activitySearch.html">Search for an Activity</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="createActivity.html">Add a new Activity</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="editActivity.html">Edit an existing Activty</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>

    <!-- (main class containg Lorem ipsum to be replaced)-->
    <main class="container">
      <h1>Home</h1>
      <br>
      <h2>Edit an existing activity</h2>
	  <h3>This page is restricted to authoried users only. Unauthorised access will be logged</h3>
	  <br>

      <!-- Slideshow container -->
      <div class="edit-container">

       <div id="searchAndEdit">
            <div id='searchbar'>
                <form action="" method="GET">
                    <input id="search-input" type="text" size="28" placeholder="Enter the ID of an activity to edit">
                    <button id="search-button" type="button" onclick="activitySearch()">Search</button>
                </form>
            </div>

            <script>
                //function that will search for activities
                function activitySearch()
                {
                    var searchTerm = document.getElementById("search-input").value;
                    //check that it isn't empty
                    if (searchTerm == "")
                    {
                        document.getElementById("searchResults").innerHTML = "No results, please enter an ID";
                        return;
                    }
                    else
                    {
                        //create new XML request
                        var xmlhttp = new XMLHttpRequest();
                        xmlhttp.onreadystatechange = function ()
                        {
                            if (this.readyState == 4 && this.status == 200) 
                            {
                                //display response text
                                document.getElementById("searchResults").innerHTML = this.responseText;
                                //display editing form
                                document.getElementById("editForm").style.display = "block";
                            }
                        };
                        //** The address on the next line of code is NOT CORRECT */
                        xmlhttp.open("GET","https://ac31007.azurewebsites.net/api/editSearch?searchInput="+searchTerm, true);
                        xmlhttp.send();
                    }
                }
            </script>

            <div id="searchResults">
                <!-- output from search will appear here -->
            </div>

            <form id="editForm" method="POST" style="display: none;">
            <!-- These fields will need to be updated to match any changes made to the database -->
                <p>Title:</p> <input id="update-title" type="text" name="update-title">
                <p>Description:</p> <textarea id="update-description" type="text" name="update-description" rows="5" cols="75"></textarea>
                <p>Street Address:</p> <input id="update-address" type="text" name="update-address">
                <p>City:</p> <input id="update-city" type="text" name="update-city">
                <p>Post Code:</p> <input id="update-postcode" type="text" name="update-postcode">
                <p>Phone Number:</p> <input id="update-number" type="text" name="update-number">
                <p>Email:</p> <input id="update-email" type="text" name="update-email">
                <p>Associated Goals:</p>
                <div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="noPoverty" value="noPoverty">
                        <label for="noPoverty">No Poverty</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="zeroHunger" value="zeroHunger">
                        <label for="zeroHunger">Zero Hunger</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="goodHealth" value="goodHealth">
                        <label for="goodHealth">Good Health and Well-Being</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="qualityEducation" value="qualityEducation">
                        <label for="qualityEducation">Quality Education</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="genderEquality" value="genderEquality">
                        <label for="genderEquality">Gender Equality</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="cleanWater" value="cleanWater">
                        <label for="cleanWater">Clean Water</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="affordableEnergy" value="affordableEnergy">
                        <label for="affordableEnergy">Affordable and Clean Energy</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="economicGrowth" value="economicGrowth">
                        <label for="economicGrowth">Decent Work and Economic Growth</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="industryAndInfrastructure" value="industryAndInfrastructure">
                        <label for="industryAndInfrastructure">Industry, Innovation and Infrastructure</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="reducedInequalities" value="reducedInequalities">
                        <label for="reducedInequalities">Reduced Inequalities</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="sustainableCommunities" value="sustainableCommunities">
                        <label for="sustainableCommunities">Sustainable Cities and Communities</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="responsibleProduction" value="responsibleProduction">
                        <label for="responsibleProduction">Responsible Consumption and Production</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="climateAction" value="climateAction">
                        <label for="climateAction">Climate Action</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="waterLife" value="waterLife">
                        <label for="waterLife">Life Below Water</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="landLife" value="landLife">
                        <label for="landLife">Life on Land</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="peaceJustice" value="peaceJustice">
                        <label for="peaceJustice">Peace, Justice and Strong Institutions</label>
                    </div>
                    <div class="goalCheckboxes">
                        <input type="checkbox" id="partnershipGoals" value="partnershipGoals">
                        <label for="partnershipGoals">Partnership for The Goals</label>
                    </div>
                </div>
                <button id="update-button" type="button">Update</button>
            </form>

            <div id="updateResults">
                <!-- results from update query will appear here -->
            </div>
        </div>

       
      </main>
    </div>
  </div>

  <!--import bootstrap JavaScript (needs to be moved to separtate JS file)-->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


<footer class="container-fluid">
  <div class="row">
    <p class="col-8 my-auto">Terms and conditions: be sustainable in Dundee.</p>
    <p class="col-4 text-right my-auto">¬© Sustainable Dundee</p>
  </div>
</footer>
</body>
</html>
